name: Build MacOS Executable and Publish Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install pyinstaller
      run: |
        pip install pyinstaller

    - name: Build executable
      run: pyinstaller --onefile main.py

    - name: Get latest commit message
      id: commit_message
      run: echo "::set-output name=message::$(git log --format=%B -n 1 ${{ github.sha }})"
    
    - name: Create Release
      id: create_release
      uses: actions/github-script@v4
      with:
        github-token: ${{ secrets.TOKEN_FOR_PUBLIC }}
        script: |
          const startingVersion = "v0.0.1";

          // Получаем последний релиз
          const { data: latestRelease } = await github.repos.getLatestRelease({
            owner: context.repo.owner,
            repo: context.repo.repo
          });

          // Получаем номер текущего релиза
          let currentVersion = latestRelease ? latestRelease.tag_name : startingVersion;
          let versionComponents = currentVersion.replace('v', '').split('.').map(Number);

          // Увеличиваем номер версии на 1
          versionComponents[2]++;
          const nextVersion = `v${versionComponents.join('.')}`;

          // Создаем новый релиз
          await github.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: nextVersion,
            name: nextVersion,
            body: ${{ steps.commit_message.outputs.message }},
            draft: false,
            prerelease: false
          });

          console.log(`Created release ${nextVersion}`);

    
    - name: Upload Release Asset
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/main
        asset_name: main.exe
        asset_content_type: application/octet-stream
